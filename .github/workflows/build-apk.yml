name: ğŸš€ æ„å»ºAndroid APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'æ„å»ºç±»å‹'
        required: true
        default: 'debug'
        type: choice
        options:
        - debug
        - release
        - both

env:
  NODE_VERSION: '22.14.0'
  JAVA_VERSION: '17'
  GRADLE_OPTS: '-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.configureondemand=true -Dorg.gradle.jvmargs=-Xmx4g'

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: è®¾ç½®Javaç¯å¢ƒ
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}
        
    - name: è®¾ç½®Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 33
        build-tools: 33.0.0
        
    - name: ç¼“å­˜Gradleä¾èµ–
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          android/.gradle
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
        
    - name: ç¼“å­˜node_modules
      uses: actions/cache@v4
      with:
        path: node_modules
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
        
    - name: å®‰è£…ä¾èµ–
      run: |
        npm ci --prefer-offline --no-audit
        
    - name: éªŒè¯ç¯å¢ƒ
      run: |
        echo "Node.jsç‰ˆæœ¬: $(node --version)"
        echo "npmç‰ˆæœ¬: $(npm --version)"
        echo "Javaç‰ˆæœ¬: $(java -version)"
        echo "å½“å‰ç›®å½•: $(pwd)"
        echo "é¡¹ç›®æ–‡ä»¶:"
        ls -la
        
    - name: æ„å»ºWebåº”ç”¨
      run: |
        echo "å¼€å§‹æ„å»ºWebåº”ç”¨..."
        npm run build
        echo "Webåº”ç”¨æ„å»ºå®Œæˆ"
        ls -la dist/
        
    - name: å®‰è£…Capacitor CLI
      run: |
        npm install -g @capacitor/cli@latest
        npx cap --version
        
    - name: æ¸…ç†Androidé¡¹ç›®
      run: |
        echo "æ¸…ç†Androidé¡¹ç›®..."
        rm -rf android/app/src/main/assets/public || true
        rm -rf android/capacitor-cordova-android-plugins/src/main || true
        
    - name: åŒæ­¥Androidé¡¹ç›®
      run: |
        echo "åŒæ­¥Androidé¡¹ç›®..."
        npx cap sync android --verbose
        echo "åŒæ­¥å®Œæˆ"
        
    - name: éªŒè¯Androidé¡¹ç›®ç»“æ„
      run: |
        echo "éªŒè¯Androidé¡¹ç›®ç»“æ„..."
        ls -la android/
        ls -la android/app/src/main/assets/ || true
        
    - name: æ„å»ºAndroid APK (Debug)
      if: github.event.inputs.build_type == 'debug' || github.event.inputs.build_type == 'both' || github.event.inputs.build_type == ''
      run: |
        echo "ğŸ”¨ å¼€å§‹æ„å»ºDebug APK..."
        cd android
        chmod +x ./gradlew
        
        # æ¸…ç†é¡¹ç›®
        echo "ğŸ§¹ æ¸…ç†é¡¹ç›®..."
        ./gradlew clean --no-daemon
        
        # æ„å»ºDebug APK
        echo "ğŸ“± æ„å»ºDebug APK..."
        ./gradlew assembleDebug --no-daemon --stacktrace --info --warning-mode all
        
        # éªŒè¯APKæ–‡ä»¶
        if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
          echo "âœ… Debug APKæ„å»ºæˆåŠŸ"
          ls -la app/build/outputs/apk/debug/
        else
          echo "âŒ Debug APKæ„å»ºå¤±è´¥"
          exit 1
        fi
        
    - name: æ„å»ºAndroid APK (Release)
      if: (github.ref == 'refs/heads/main' && (github.event.inputs.build_type == 'release' || github.event.inputs.build_type == 'both' || github.event.inputs.build_type == '')) || github.event.inputs.build_type == 'release'
      run: |
        echo "ğŸ”¨ å¼€å§‹æ„å»ºRelease APK..."
        cd android
        
        # æ„å»ºRelease APK
        echo "ğŸ“± æ„å»ºRelease APK..."
        ./gradlew assembleRelease --no-daemon --stacktrace --info --warning-mode all
        
        # éªŒè¯APKæ–‡ä»¶
        if [ -f "app/build/outputs/apk/release/app-release-unsigned.apk" ]; then
          echo "âœ… Release APKæ„å»ºæˆåŠŸ"
          ls -la app/build/outputs/apk/release/
        else
          echo "âŒ Release APKæ„å»ºå¤±è´¥"
          exit 1
        fi
        
    - name: ğŸ“Š APKä¿¡æ¯ç»Ÿè®¡
      if: always()
      run: |
        echo "ğŸ“Š APKæ„å»ºç»Ÿè®¡ä¿¡æ¯:"
        echo "================================"
        
        # Debug APKä¿¡æ¯
        if [ -f "android/app/build/outputs/apk/debug/app-debug.apk" ]; then
          debug_size=$(stat -c%s "android/app/build/outputs/apk/debug/app-debug.apk")
          debug_size_mb=$((debug_size / 1024 / 1024))
          echo "ğŸ› Debug APK: ${debug_size_mb}MB (${debug_size} bytes)"
        fi
        
        # Release APKä¿¡æ¯
        if [ -f "android/app/build/outputs/apk/release/app-release-unsigned.apk" ]; then
          release_size=$(stat -c%s "android/app/build/outputs/apk/release/app-release-unsigned.apk")
          release_size_mb=$((release_size / 1024 / 1024))
          echo "ğŸš€ Release APK: ${release_size_mb}MB (${release_size} bytes)"
        fi
        
        echo "================================"
        
    - name: ğŸ“¦ ä¸Šä¼ Debug APK
      if: success() && (github.event.inputs.build_type == 'debug' || github.event.inputs.build_type == 'both' || github.event.inputs.build_type == '')
      uses: actions/upload-artifact@v4
      with:
        name: èŠå¤©åº”ç”¨-Debug-v${{ github.run_number }}
        path: android/app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30
        
    - name: ğŸ“¦ ä¸Šä¼ Release APK
      if: success() && ((github.ref == 'refs/heads/main' && (github.event.inputs.build_type == 'release' || github.event.inputs.build_type == 'both' || github.event.inputs.build_type == '')) || github.event.inputs.build_type == 'release')
      uses: actions/upload-artifact@v4
      with:
        name: èŠå¤©åº”ç”¨-Release-v${{ github.run_number }}
        path: android/app/build/outputs/apk/release/app-release-unsigned.apk
        retention-days: 90
        
    - name: ä¸Šä¼ æ„å»ºæ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ github.run_number }}
        path: |
          android/build/reports/
          android/app/build/reports/
        retention-days: 7
        
    - name: ğŸ‰ åˆ›å»ºGitHub Release
      if: github.ref == 'refs/heads/main' && success()
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: ğŸš€ èŠå¤©åº”ç”¨ v${{ github.run_number }}
        body: |
          ## ğŸ“± èŠå¤©åº”ç”¨ APK å‘å¸ƒ
          
          > ğŸ¯ **ä¸€é”®ä¸‹è½½å³ç”¨çš„AndroidèŠå¤©åº”ç”¨**
          
          ### ğŸš€ ç‰ˆæœ¬ä¿¡æ¯
          - **æ„å»ºç¼–å·**: `${{ github.run_number }}`
          - **æäº¤å“ˆå¸Œ**: `${{ github.sha }}`
          - **æ„å»ºæ—¶é—´**: `${{ github.event.head_commit.timestamp }}`
          - **æ„å»ºåˆ†æ”¯**: `${{ github.ref_name }}`
          
          ### ğŸ“¦ ä¸‹è½½æ–‡ä»¶
          | æ–‡ä»¶å | ç±»å‹ | ç”¨é€” | æ¨è |
          |--------|------|------|------|
          | `app-debug.apk` | è°ƒè¯•ç‰ˆ | å¼€å‘æµ‹è¯• | ğŸ§ª æµ‹è¯•ç”¨æˆ· |
          | `app-release-unsigned.apk` | å‘å¸ƒç‰ˆ | ç”Ÿäº§ä½¿ç”¨ | â­ æ¨èä¸‹è½½ |
          
          ### ğŸ”§ å®‰è£…è¯´æ˜
          1. **ä¸‹è½½APK**: ç‚¹å‡»ä¸‹æ–¹æ–‡ä»¶é“¾æ¥ä¸‹è½½
          2. **å¯ç”¨å®‰è£…**: Androidè®¾å¤‡ â†’ è®¾ç½® â†’ å®‰å…¨ â†’ å…è®¸æœªçŸ¥æ¥æº
          3. **å®‰è£…åº”ç”¨**: ç‚¹å‡»ä¸‹è½½çš„APKæ–‡ä»¶è¿›è¡Œå®‰è£…
          4. **å¼€å§‹ä½¿ç”¨**: æ‰“å¼€åº”ç”¨ï¼Œæ³¨å†Œè´¦å·å³å¯å¼€å§‹èŠå¤©
          
          ### âœ¨ åº”ç”¨ç‰¹æ€§
          - ğŸ’¬ å®æ—¶èŠå¤©æ¶ˆæ¯
          - ğŸ‘¥ å¥½å‹ç®¡ç†ç³»ç»Ÿ
          - ğŸ“± ç§»åŠ¨ç«¯ä¼˜åŒ–ç•Œé¢
          - ğŸ”’ å®‰å…¨çš„ç”¨æˆ·è®¤è¯
          - ğŸ“¸ å›¾ç‰‡åˆ†äº«åŠŸèƒ½
          - ğŸŒ è·¨å¹³å°åŒæ­¥
          
          ### ğŸ“ æœ¬æ¬¡æ›´æ–°
          ```
          ${{ github.event.head_commit.message }}
          ```
          
          ### ğŸ› é—®é¢˜åé¦ˆ
          å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨ [Issues](../../issues) é¡µé¢åé¦ˆ
          
          ---
          
          **ğŸ“² ç«‹å³ä¸‹è½½ä½“éªŒæœ€æ–°ç‰ˆæœ¬ï¼**
        files: |
          android/app/build/outputs/apk/debug/app-debug.apk
          android/app/build/outputs/apk/release/app-release-unsigned.apk
        draft: false
        prerelease: false
        make_latest: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ“¢ æ„å»ºå®Œæˆé€šçŸ¥
      if: always()
      run: |
        echo "========================================="
        echo "ğŸ‰ GitHub Actions æ„å»ºæµç¨‹å®Œæˆï¼"
        echo "========================================="
        
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… æ„å»ºçŠ¶æ€: æˆåŠŸ"
          echo "ğŸ“¦ APKæ–‡ä»¶å·²ç”Ÿæˆå¹¶ä¸Šä¼ "
          echo "ğŸ”— ä¸‹è½½åœ°å€: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "ğŸ‰ Releaseå·²åˆ›å»º: https://github.com/${{ github.repository }}/releases/latest"
          fi
        else
          echo "âŒ æ„å»ºçŠ¶æ€: å¤±è´¥"
          echo "ğŸ“‹ è¯·æŸ¥çœ‹æ„å»ºæ—¥å¿—æ’æŸ¥é—®é¢˜"
        fi
        
        echo "========================================="
