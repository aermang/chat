name: 🔧 修复版APK构建

on:
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  JAVA_VERSION: '17'

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: 📥 检出代码
      uses: actions/checkout@v4
      
    - name: 🟢 设置Node.js环境
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ☕ 设置Java环境
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}
        
    - name: 🤖 设置Android SDK
      uses: android-actions/setup-android@v3
      with:
        cmdline-tools-version: 8512546
        accept-android-sdk-licenses: true
        packages: |
          platform-tools
          platforms;android-33
          build-tools;33.0.0
          
    - name: 🔍 环境验证
      run: |
        echo "=== 环境信息 ==="
        node --version
        npm --version
        java -version
        echo "ANDROID_HOME: $ANDROID_HOME"
        echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
        
    - name: 📦 安装依赖
      run: |
        echo "安装项目依赖..."
        npm ci --prefer-offline --no-audit
      timeout-minutes: 8
        
    - name: 🏗️ 构建Web应用
      run: |
        echo "构建Web应用..."
        npm run build
        echo "检查构建输出..."
        ls -la dist/
      timeout-minutes: 8
        
    - name: ⚡ 安装Capacitor CLI
      run: |
        npm install -g @capacitor/cli@5.7.0
        npx cap --version
        
    - name: 🔄 同步Android项目
      run: |
        echo "同步Android项目..."
        npx cap sync android --verbose
        
        echo "验证Android项目结构..."
        ls -la android/
        ls -la android/app/
        
    - name: 📱 构建APK
      run: |
        echo "进入Android目录..."
        cd android
        
        echo "设置Gradle权限..."
        chmod +x ./gradlew
        
        echo "显示Gradle版本..."
        ./gradlew --version
        
        echo "清理项目..."
        ./gradlew clean --no-daemon
        
        echo "构建Debug APK..."
        ./gradlew assembleDebug --no-daemon --stacktrace
        
        echo "验证APK文件..."
        if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
          echo "✅ APK构建成功！"
          ls -la app/build/outputs/apk/debug/
          file app/build/outputs/apk/debug/app-debug.apk
        else
          echo "❌ APK构建失败"
          echo "搜索所有APK文件..."
          find . -name "*.apk" -type f
          exit 1
        fi
      timeout-minutes: 15
        
    - name: 📤 上传APK文件
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: 聊天应用-修复版-APK
        path: android/app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30
        
    - name: 🎉 构建完成
      if: always()
      run: |
        echo "================================="
        if [ "${{ job.status }}" == "success" ]; then
          echo "🎉 构建成功！APK已生成并上传"
          echo "📱 下载地址：Artifacts -> 聊天应用-修复版-APK"
        else
          echo "❌ 构建失败，请查看详细日志"
        fi
        echo "================================="
