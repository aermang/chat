name: ğŸ”§ ä¿®å¤ç‰ˆAPKæ„å»º

on:
  workflow_dispatch:
    inputs:
      debug_enabled:
        description: 'å¯ç”¨è°ƒè¯•æ¨¡å¼'
        required: false
        default: 'false'
        type: boolean
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-android:
    name: ğŸš€ æ„å»ºAndroid APK
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ğŸ”§ è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: â˜• è®¾ç½®Javaç¯å¢ƒ
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: ğŸ“± è®¾ç½®Android SDK
      uses: android-actions/setup-android@v3
      with:
        packages: |
          platform-tools
          platforms;android-33
          platforms;android-34
          build-tools;33.0.0
          build-tools;34.0.0
          cmdline-tools;latest
        cmdline-tools-version: '9.0'
        accept-licenses: true
        
    - name: ğŸ” éªŒè¯ç¯å¢ƒé…ç½®
      run: |
        echo "=== ç¯å¢ƒä¿¡æ¯ ==="
        node --version
        npm --version
        java -version
        echo "ANDROID_HOME: $ANDROID_HOME"
        echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
        ls -la $ANDROID_HOME/platforms/ || echo "å¹³å°ç›®å½•ä¸å­˜åœ¨"
        ls -la $ANDROID_HOME/build-tools/ || echo "æ„å»ºå·¥å…·ç›®å½•ä¸å­˜åœ¨"
        
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        echo "=== å®‰è£…é¡¹ç›®ä¾èµ– ==="
        npm ci --prefer-offline --no-audit
        echo "=== ä¾èµ–å®‰è£…å®Œæˆ ==="
        
    - name: ğŸ—ï¸ æ„å»ºWebåº”ç”¨
      run: |
        echo "=== å¼€å§‹æ„å»ºWebåº”ç”¨ ==="
        npm run build
        echo "=== Webåº”ç”¨æ„å»ºå®Œæˆ ==="
        ls -la dist/ || ls -la build/ || echo "æ„å»ºè¾“å‡ºç›®å½•æ£€æŸ¥"
        
    - name: ğŸ“± å®‰è£…Capacitor CLI
      run: |
        echo "=== å®‰è£…Capacitor CLI ==="
        npm install -g @capacitor/cli
        npx cap --version
        
    - name: ğŸ”„ åŒæ­¥Androidé¡¹ç›®
      run: |
        echo "=== åŒæ­¥Capacitor Androidé¡¹ç›® ==="
        npx cap sync android --verbose
        echo "=== æ£€æŸ¥Androidé¡¹ç›®ç»“æ„ ==="
        ls -la android/
        ls -la android/app/src/main/ || echo "Androidä¸»ç›®å½•ä¸å­˜åœ¨"
        
    - name: ğŸ”¨ æ„å»ºDebug APK
      timeout-minutes: 20
      run: |
        cd android
        echo "=== æ£€æŸ¥Gradleæ–‡ä»¶ ==="
        ls -la
        ls -la app/
        
        echo "=== è®¾ç½®Gradleæƒé™ ==="
        chmod +x ./gradlew
        
        echo "=== æ¸…ç†é¡¹ç›® ==="
        ./gradlew clean --stacktrace --info
        
        echo "=== æ„å»ºDebug APK ==="
        ./gradlew assembleDebug --stacktrace --info --no-daemon
        
        echo "=== æ£€æŸ¥æ„å»ºè¾“å‡º ==="
        find . -name "*.apk" -type f
        ls -la app/build/outputs/apk/debug/ || echo "APKè¾“å‡ºç›®å½•ä¸å­˜åœ¨"
        
        echo "=== æ˜¾ç¤ºAPKæ–‡ä»¶å¤§å° ==="
        if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
          ls -lh app/build/outputs/apk/debug/app-debug.apk
          echo "âœ… APKæ„å»ºæˆåŠŸï¼"
        else
          echo "âŒ APKæ–‡ä»¶æœªæ‰¾åˆ°"
          exit 1
        fi
        
    - name: ğŸ“¤ ä¸Šä¼ APKæ–‡ä»¶
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: android-debug-apk
        path: android/app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30
        
    - name: ğŸ“Š æ„å»ºå®Œæˆé€šçŸ¥
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸ‰ APKæ„å»ºæˆåŠŸå®Œæˆï¼"
          echo "ğŸ“± APKæ–‡ä»¶å·²ä¸Šä¼ åˆ°Artifacts"
          echo "â¬‡ï¸ æ‚¨å¯ä»¥åœ¨Actionsé¡µé¢ä¸‹è½½APKæ–‡ä»¶"
        else
          echo "âŒ APKæ„å»ºå¤±è´¥"
          echo "ğŸ” è¯·æŸ¥çœ‹ä¸Šè¿°æ—¥å¿—äº†è§£è¯¦ç»†é”™è¯¯ä¿¡æ¯"
        fi
